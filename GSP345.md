# **Automating Infrastructure on Google Cloud with Terraform: Challenge Lab # GSP345**

## **Variables Preparation**
Command to create variables need for this lab

    export PROJECT_ID=<your project>
    export REGION=<your region>
    export ZONE=<your zone>
    export BUCKET_NAME=<your bucket name>
    export INSTANCE_NAME=<your instance name>
    export VPC_NAME=<your vpc name>
    export INSTANCE1_ID=<instance 1 id>
    export INSTANCE2_ID=<instance 2 id>
    export INSTANCE3_ID=<instance 3 id>

Command to select your project if it was deselected

    gcloud config set project $PROJECT_ID

<br>

___
## **Task 1: Create the configuration files**
Make the empty files and directories in _Cloud Shell_ or the _Cloud Shell Editor_.

    touch main.tf
    touch variables.tf
    mkdir modules
    mkdir modules/instances
    touch modules/instances/instances.tf
    touch modules/instances/outputs.tf
    touch modules/instances/variables.tf
    mkdir modules/storage
    touch modules/storage/storage.tf
    touch modules/storage/outputs.tf
    touch modules/storage/variables.tf

Add the following to the each _variables.tf_ file, and fill in the _GCP Project ID_:

    echo "variable \"region\" { 
    default = \"$REGION\" 
    } 
 
    variable \"zone\" {
    default = \"$ZONE\"
    }

    variable \"project_id\" {
    default = \"$PROJECT_ID\"
    }" > variables.tf

Add the following to the _main.tf_ file:

    echo "terraform {
        required_providers {
            google = {
            source = \"hashicorp/google\"
            version = \"3.55.0\"
            }
        }
    } 

    provider \"google\" {
        project     = var.project_id
        region      = var.region
        zone        = var.zone
    }


    module \"instances\" {
        source     = \"./modules/instances\"
    }" > main.tf

Run "_terraform init_" in Cloud Shell in the root directory to initialize terraform.

    terraform init
<br>

___

## **Task 2: Import infrastructure**
Navigate to _Compute Engine > VM Instances_. Click on _tf-instance-1_. Copy the _Instance ID_ down somewhere to use later.

Navigate to _Compute Engine > VM Instances_. Click on _tf-instance-2_. Copy the _Instance ID_ down somewhere to use later. 

Next, navigate to _modules/instances/instances.tf_. Copy the following configuration into the file:

    echo "resource \"google_compute_instance\" \"tf-instance-1\" {
        name         = \"tf-instance-1\"
        machine_type = \"n1-standard-1\"

        boot_disk {
            initialize_params {
                image = \"debian-cloud/debian-10\"
            }
        }

        network_interface {
            network = \"default\"
        }

        metadata_startup_script = <<-EOT
        #!/bin/bash
        EOT

        allow_stopping_for_update = true
    }

    resource \"google_compute_instance\" \"tf-instance-2\" {
        name         = \"tf-instance-2\"
        machine_type = \"n1-standard-1\"

        boot_disk {
            initialize_params {
                image = \"debian-cloud/debian-10\"
            }
        }

        network_interface {
            network = \"default\"
        }

        metadata_startup_script = <<-EOT
        #!/bin/bash
        EOT

        allow_stopping_for_update = true
    }" > modules/instances/instances.tf

To import the first instance, use the following command, using the Instance ID for _tf-instance-1_ you copied down earlier.

    terraform import module.instances.google_compute_instance.tf-instance-1 $INSTANCE1_ID

To import the second instance, use the following command, using the Instance ID for _tf-instance-2_ you copied down earlier.

    terraform import module.instances.google_compute_instance.tf-instance-2 $INSTANCE2_ID

The two instances have now been imported into your terraform configuration. You can now run the commands to update the state of Terraform. Type _yes_ at the dialogue after you run the apply command to accept the state changes.

    terraform plan
    terraform apply
<br>

___
## **Task 3: Configure a remote backend** 
Add the following code to the _modules/storage/storage.tf_ file, and fill in the _Bucket Name_:

    echo "resource \"google_storage_bucket\" \"storage-bucket\" {
        name          = \"$BUCKET_NAME\"
        location      = \"US\"
        force_destroy = true
        uniform_bucket_level_access = true
    }" > modules/storage/storage.tf

Next, add the following to the _main.tf_ file:

    echo "module \"storage\" {
        source     = \"./modules/storage\"
    }" >> main.tf

Run the following commands to initialize the module and create the storage bucket resource. Type _yes_ at the dialogue after you run the apply command to accept the state changes.

    terraform init
    terraform apply

Next, update the _main.tf_ file so that the terraform block looks like the following. Fill in your _GCP Project ID_ for the bucket argument definition.

    echo "terraform {
        backend \"gcs\" {
            bucket  = \"$PROJECT_ID\"
            prefix  = \"terraform/state\"
        }
        required_providers {
            google = {
                source = \"hashicorp/google\"
                version = \"3.55.0\"
            }
        }
    }" >> main.tf

Run the following to initialize the remote backend. Type _yes_ at the prompt.

    terraform init
<br>

___
## **Task 4: Modify and update infrastructure**
Navigate to _modules/instances/instance.tf_. Replace the entire contents of the file with the following, and fill in your _Instance 3 ID_:

    echo "resource \"google_compute_instance\" \"tf-instance-1\" {
        name         = \"tf-instance-1\"
        machine_type = \"n1-standard-2\"
        zone         = \"$ZONE\"
        allow_stopping_for_update = true

        boot_disk {
            initialize_params {
                image = \"debian-cloud/debian-10\"
            }
        }

        network_interface {
            network = \"default\"
        }
    }

    resource \"google_compute_instance\" \"tf-instance-2\" {
        name         = \"tf-instance-2\"
        machine_type = \"n1-standard-2\"
        zone         = \"$ZONE\"
        allow_stopping_for_update = true

        boot_disk {
            initialize_params {
                image = \"debian-cloud/debian-10\"
            }
        }

        network_interface {
            network = \"default\"
        }
    }

    resource \"google_compute_instance\" \"tf-instance-3\" {
        name         = \"<tf-instance-3\"
        machine_type = \"n1-standard-2\"
        zone         = \"us-central1-a\"
        allow_stopping_for_update = true

        boot_disk {
            initialize_params {
                image = \"debian-cloud/debian-10\"
            }
        }

        network_interface {
            network = \"default\"
        }
    }" > modules/instances/instance.tf

Run the following commands to initialize the module and create/update the instance resources. Type _yes_ at the dialogue after you run the apply command to accept the state changes.

    terraform init
    terraform apply
<br>

___
## **Task 5: Taint and destroy resources**
Taint the _tf-instance-3_ resource by running the following command, and fill in your _Instance 3 ID_:

    terraform taint module.instances.google_compute_instance.$INSTANCE3_ID

Run the following commands to apply the changes:

    terraform init
    terraform apply

Remove the _tf-instance-3_ resource from the _instances.tf_ file. Delete the following code chunk from the file.

    resource "google_compute_instance" "<FILL IN INSTANCE 3 NAME>" {
        name         = "<FILL IN INSTANCE 3 NAME>"
        machine_type = "n1-standard-2"
        zone         = "us-central1-a"
        allow_stopping_for_update = true

        boot_disk {
            initialize_params {
                image = "debian-cloud/debian-10"
            }
        }

        network_interface {
            network = "default"
        }
    }

Run the following commands to apply the changes. Type _yes_ at the prompt.

    terraform apply

<br>

___
## **Task 6: Use a module from the Registry**
Copy and paste the following to the end of _main.tf_ file, fill in _Version Number_ and _Network Name_ instructed in the challenge:

    module "vpc" {
        source  = "terraform-google-modules/network/google"
        version = "~> <FILL IN VERSION NUMBER>"

        project_id   = "qwiklabs-gcp-04-f2c1c01a09d3"
        network_name = "<FILL IN NETWORK NAME>"
        routing_mode = "GLOBAL"

        subnets = [
            {
                subnet_name           = "subnet-01"
                subnet_ip             = "10.10.10.0/24"
                subnet_region         = "us-central1"
            },
            {
                subnet_name           = "subnet-02"
                subnet_ip             = "10.10.20.0/24"
                subnet_region         = "us-central1"
                subnet_private_access = "true"
                subnet_flow_logs      = "true"
                description           = "This subnet has a description"
            }
        ]
    }

Run the following commands to initialize the module and create the VPC. Type _yes_ at the prompt.

    terraform init
    terraform apply

Navigate to _modules/instances/instances.tf_. Replace the entire contents of the file with the following:

    resource "google_compute_instance" "tf-instance-1" {
        name         = "tf-instance-1"
        machine_type = "n1-standard-2"
        zone         = "us-central1-a"
        allow_stopping_for_update = true

        boot_disk {
            initialize_params {
                image = "debian-cloud/debian-10"
            }
        }

        network_interface {
            network = "<FILL IN NETWORK NAME>"
            subnetwork = "subnet-01"
        }
    }

    resource "google_compute_instance" "tf-instance-2" {
        name         = "tf-instance-2"
        machine_type = "n1-standard-2"
        zone         = "us-central1-a"
        allow_stopping_for_update = true

        boot_disk {
            initialize_params {
                image = "debian-cloud/debian-10"
            }
        }

        network_interface {
            network = "<FILL IN NETWORK NAME>"
            subnetwork = "subnet-02"
        }
    }

Run the following commands to initialize the module and update the instances. Type _yes_ at the prompt.

    terraform init
    terraform apply

<br/>

___
## **Task 7: Configure a firewall**
Add the following resource to the _main.tf_ file, fill in the _GCP Project ID_ and _Network Name_:

    resource "google_compute_firewall" "tf-firewall" {
        name    = "tf-firewall"
        network = "projects/<FILL IN PROJECT_ID>/global/networks/<FILL IN NETWORK NAME>"

        allow {
            protocol = "tcp"
            ports    = ["80"]
        }

        source_tags = ["web"]
        source_ranges = ["0.0.0.0/0"]
    }

Run the following commands to configure the firewall. Type _yes_ at the prompt.

    terraform init
    terraform apply
